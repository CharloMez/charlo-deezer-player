<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="http://cdn-files.deezer.com/js/min/dz.js"></script>
</head>
<body>

<div id="dz-root"></div>
<div id="player" style="width:100%;" align="center"></div>

<input type="button" onclick="loginDeezer()" value="Login"/>
<p id="name"></p>

<div id="playlist" hidden="hidden">
    <label>chargé une playlist via son url de partage</label>
    <br />
    <input size="100" type="text" id="playlist_url" >
    <br />
    <input type="button" onclick="load('playlist', loadPlaylist)" value="charger"/>
    <input type="hidden" id="playlist_id" value="-1">
</div>

<div id="song" hidden="hidden">
    <label>Ajouté une musique dans votre playlist via son url de partage</label>
    <br />
    <input size="100" type="text" id="track_url" >
    <br />
    <input type="button" onclick="load('track', loadTrack)" value="charger"/>
    <input type="hidden" id="track_id" value="-1">
</div>

<p style="color: red" id="error"></p>
<input type="hidden" id="access_token" value="-1">
<input type="hidden" id="current_index" value="0">

<script>
    function getElementId(url)
    {
        var elementId = -1;

        url = url.split('?');
        url = url[0].split('/');

        if (url.length > 0) {
            elementId = url[url.length - 1];
        }

        if (elementId !== -1 && !isNaN(parseInt(elementId))) {
            console.log('get playlist id = ' + parseInt(elementId));

            return parseInt(elementId);
        }

        return -1;
    }

    function load(type, callback)
    {
        console.log('loading ' + type);
        document.getElementById('error').innerHTML = '';

        var url = document.getElementById(type + '_url').value;
        var elementId = getElementId(url);

        if (elementId === -1) {
            document.getElementById('error').innerHTML = 'Enable to extract the ' + type + ' id';

            return false;
        }

        loadType(type, elementId, callback);

        return true;
    }

    function loadPlaylist()
    {
        console.log('loading playlist');
        var id = document.getElementById('playlist_id').value;
        var index = document.getElementById('current_index').value;
        console.log('playlist id = ' + id);
        DZ.player.playPlaylist(parseInt(id), parseInt(index));
        console.log('done');
        document.getElementById('song').removeAttribute('hidden');
    }

    function loadTrack()
    {
        console.log('loading track');
        var playlistId = document.getElementById('playlist_id').value;
        var id = document.getElementById('track_id').value;
        var token = document.getElementById('access_token').value;
        var xhr = new XMLHttpRequest();

        xhr.open('POST', 'https://api.deezer.com/playlist/' + playlistId + '/tracks?access_token=' + token);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.send('songs=' + id + '&access_token=' + token);
        document.getElementById('access_token').value = DZ.player.getCurrentIndex();
        document.getElementsByName('player').removeChild();
        initPlayer(loadPlaylist);
    }

    function loginDeezer()
    {
        DZ.login(function(response) {
            if (response.authResponse) {
                console.log(JSON.stringify(response));
                document.getElementById('access_token').value = response.authResponse.accessToken;
                DZ.api('/user/me', function(response) {
                    document.getElementById('name').innerHTML = 'Salut ' + response.firstname;
                });

                document.getElementById('playlist').removeAttribute('hidden');
            } else {
                document.getElementById('error').innerHTML = 'An error occurred with login !';
            }
        }, {perms: 'manage_library,basic_access,email'});
    }

    function playerLoaded()
    {
        console.log('player is loaded');
    }

    function loadType(type, id, callback)
    {
        console.log('check is type ' + type);
        console.log('url = ' + '/' + type + '/' + id);
        DZ.api('/' + type + '/' + id, function(response) {
            console.log(JSON.stringify(response));
            console.log('typeof = ' + typeof response.error);
            if (typeof response.error === "undefined") {
                console.log('callback with id ' + id);
                document.getElementById(type + '_id').value = id;
                callback();
            } else {
                document.getElementById('error').innerHTML = 'Not a valid ' + type;
            }
        });
    }

    function initPlayer(callback)
    {
        DZ.init({
            appId : '190582',
            channelUrl : 'http://test.mobnweb.com/channel.html',
            player: {
                container : 'player',
                cover : true,
                playlist : true,
                width : 650,
                height : 300
            }
        });
        DZ.Event.subscribe('player_loaded', callback);
    }

    initPlayer(playerLoaded);
</script>

</body>
</html>